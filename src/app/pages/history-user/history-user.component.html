<!-- Contenedor principal -->
<div
  class="rounded-2xl shadow-md p-4 sm:p-6 lg:p-10 mb-8 bg-gradient-to-br from-[#ffffff] to-[#008f8f] border border-[#cfe7e4]">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3 mb-6">
    <div class="flex items-center gap-3">
      <!-- Botón Atrás -->
      <button type="button" (click)="volver()"
        class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-[#0f766e] border-[#0f766e]/30 hover:bg-[#0f766e]/10 hover:border-[#0f766e]/40 transition shadow-sm w-full sm:w-auto">
        <span class="inline-block -ml-1 text-lg">←</span>
      </button>
    </div>
  </div>

  <!-- ==================== POPUP CREAR HISTORIA ==================== -->

  <div *ngIf="mostrarModalCreacion" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
    <div
      class="bg-white rounded-2xl shadow-xl w-[90vw] sm:w-[900px] max-w-[94vw] p-4 sm:p-6 max-h-[90vh] overflow-y-auto">
      <!-- Encabezado igual al de Iniciativas -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">
          Crear Historia de Usuario
        </h3>
        <button class="text-gray-500 hover:text-gray-700" (click)="closeDialog()">✕</button>
      </div>

      <!-- Cuerpo -->
      <form [formGroup]="historiaForm" (ngSubmit)="crearHistoria()" class="grid grid-cols-12 gap-3">
        <div class="col-span-12 md:col-span-6">
          <label class="block text-sm mb-1">Nombre de la Historia *</label>
          <input class="w-full rounded-lg border px-3 py-2 text-sm" type="text" formControlName="nombre_historia">
        </div>

        <div class="col-span-12">
          <label class="block text-sm mb-1">Descripción *</label>
          <textarea rows="3" class="w-full rounded-lg border px-3 py-2 text-sm"
            formControlName="descripcion"></textarea>
        </div>

        <div class="col-span-12 md:col-span-6">
          <label class="block text-sm mb-1">Fecha de Inicio *</label>
          <input type="date" formControlName="fecha_inicio" class="w-full rounded-lg border px-3 py-2 text-sm bg-white text-gray-900
           focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
        </div>


        <div class="col-span-12 md:col-span-6">
          <label class="block text-sm mb-1">Fecha de Fin *</label>
          <input type="date" formControlName="fecha_inicio" class="w-full rounded-lg border px-3 py-2 text-sm bg-white text-gray-900
           focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
        </div>

        <div *ngIf="errorGuardar" class="text-red-600 text-sm col-span-12">
          {{ errorGuardar }}
        </div>

        <!-- Botones igual al modal de Iniciativas -->
        <div class="col-span-12 mt-5 flex flex-col sm:flex-row sm:justify-end gap-2">
          <button type="button"
            class="px-4 py-2 rounded-lg border border-gray-300 text-sm hover:bg-gray-50 w-full sm:w-auto"
            (click)="closeDialog()">
            Cancelar
          </button>
          <button type="submit"
            class="px-4 py-2 rounded-lg bg-[#00a1a1] text-white text-sm hover:bg-[#008f8f] w-full sm:w-auto"
            [disabled]="historiaForm.invalid">
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
  <!-- ===== FIN Modal CREAR HISTORIA DE USUARIO ===== -->


  <!-- ==================== POPUP EDITAR HISTORIA (ESTADO) ==================== -->
  <ng-template #editarHistoriaTpl>
    <!-- Contenedor con el mismo estilo del modal "Crear Historia de Usuario" -->
    <div
      class="bg-white rounded-2xl shadow-xl w-[90vw] sm:w-[900px] max-w-[94vw] p-4 sm:p-6 max-h-[90vh] overflow-y-auto">
      <!-- Header idéntico -->
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Editar estado de la historia</h3>
        <button class="text-gray-500 hover:text-gray-700" type="button" (click)="closeEditarHistoriaDialog()">✕</button>
      </div>

      <!-- Info de la historia (igual jerarquía visual) -->
      <div class="mb-3 text-sm text-gray-700">
        <div><b>ID:</b> {{ historiaEditando?.id_historia }}</div>
        <div><b>Nombre:</b> {{ historiaEditando?.nombre_historia }}</div>
      </div>

      <!-- Cuerpo con misma grilla y botones del modal de Crear -->
      <form [formGroup]="estadoEditForm" (ngSubmit)="guardarEstadoHistoria()" class="grid grid-cols-12 gap-3">
        <div class="col-span-12 md:col-span-6">
          <label class="block text-sm mb-1">Estado *</label>
          <!-- Solo apariencia: outline para que se vea como input con borde -->
          <!-- DESPUÉS (nativo, igual al estilo de "Ver:") -->
          <div class="w-full">
            <select formControlName="estado"
              class="rounded-lg border border-gray-300 px-3 py-2 text-sm w-full sm:w-auto min-w-0 sm:min-w-[320px] max-w-full bg-white">
              <option value="Pendiente">Pendiente</option>
              <option value="Abierta">Abierta</option>
              <option value="Cerrada">Cerrada</option>
            </select>
          </div>
        </div>

        <!-- Botonera: Eliminar a la izquierda, Cancelar/Guardar a la derecha -->
        <div class="col-span-12 mt-5 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <!-- Eliminar -->
          <button type="button"
            class="px-4 py-2 rounded-lg border border-red-200 text-red-700 hover:bg-red-50 w-full sm:w-auto"
            (click)="eliminarHistoria()">
            Eliminar
          </button>

          <!-- Derecha: Cancelar / Guardar -->
          <div class="flex gap-2 w-full sm:w-auto">
            <button type="button"
              class="px-4 py-2 rounded-lg border border-gray-300 text-sm hover:bg-gray-50 w-full sm:w-auto"
              (click)="closeEditarHistoriaDialog()">
              Cancelar
            </button>
            <button type="submit"
              class="px-4 py-2 rounded-lg bg-[#00a1a1] text-white text-sm hover:bg-[#008f8f] w-full sm:w-auto">
              Guardar
            </button>
          </div>
        </div>
      </form>
    </div>
  </ng-template>

  <!-- ==================== /POPUP EDITAR HISTORIA ==================== -->

  <!-- ============ Tabla de Historias de Usuario (mismo estilo que Actividades) ============ -->
  <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden mb-6">
    <!-- Franja superior -->
    <div 
      class="px-4 sm:px-6 py-3 sm:py-4 border-b bg-[#00a1a1] rounded-t-xl text-white flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="min-w-0">
          <h3 class="font-semibold truncate">Historias de Usuario (Iniciativa {{ idIniciativa || '—' }})</h3>
          <p class="text-[13px] opacity-90">Listado y estado de la historia de usuario por actividad</p>        
      </div>
      

      <!-- Botón Nueva historia (alineado al estilo general) -->
      <button type="button" (click)="openDialog(crearTpl)"
        class="px-3 py-2 rounded-lg bg-teal-600 text-white text-sm hover:bg-teal-500 active:scale-[0.98] transition w-full sm:w-auto">
         + Nueva historia
      </button>

    </div>

    <div class="p-4 overflow-x-auto">
      <table class="min-w-[900px] sm:min-w-full text-sm text-left text-gray-700">
        <thead class="bg-[#f9fafb] text-xs uppercase text-gray-600">
          <tr>
            <th class="px-3 py-2 w-10">#</th>
            <th class="px-3 py-2">Nombre</th>
            <th class="px-3 py-2">Estado</th>
            <th class="px-3 py-2">Inicio</th>
            <th class="px-3 py-2">Fin</th>
            <th class="px-3 py-2">% Peso</th>
            <th class="px-3 py-2">Detalle</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let h of historias" (click)="openEditarHistoriaDialog(editarHistoriaTpl, h)"
            class="border-b hover:bg-gray-50 cursor-pointer transition">

            <td class="px-3 py-2 align-top">{{ h.id_historia }}</td>

            <!-- Nombre -->
            <td class="px-3 py-2 align-top">
              <div class="font-medium text-gray-800 truncate">{{ h.nombre_historia }}</div>
              <div class="text-xs text-gray-500">{{ h.descripcion }}</div>
            </td>

            <!-- Estado con misma pill -->
            <td class="px-3 py-2 align-top">
              <span class="px-2 py-1 rounded-full border text-xs font-medium" [ngClass]="{
                    'border-amber-400 text-amber-600': h.estado === 'Pendiente',
                    'border-teal-500 text-teal-700': h.estado === 'Cerrada',
                    'border-sky-400 text-sky-700': h.estado === 'Abierta'
                  }">
                {{ h.estado || '—' }}
              </span>
            </td>


            <!-- Fechas -->
            <td class="px-3 py-2 align-top whitespace-nowrap">{{ h.fecha_inicio | date:'yyyy-MM-dd' }}</td>
            <td class="px-3 py-2 align-top whitespace-nowrap">{{ h.fecha_fin | date:'yyyy-MM-dd' }}</td>

            <!-- Peso y Aporte -->
            <td class="px-3 py-2 align-top">{{ h.peso_por_historia }}</td>
            <td class="px-3 py-2 align-top">{{ h.descripcion }}</td>
          </tr>

          <tr *ngIf="historias.length === 0">
            <td colspan="8" class="px-3 py-6 text-center text-gray-500">
              No hay historias registradas para esta iniciativa.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>


</div>